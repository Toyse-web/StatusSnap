<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusSnap - WhatsApp Video Optimizer</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>StatusSnap</h1>
        <p>Optimize your videos for WhatsApp status (up to 90 seconds, no blur!)</p>

        <form id="uploadForm" enctype="multipart/form-data" method="POST" action="/process-video">
            <input type="file" name="video" accept="video/*" required>
            <button type="submit">Process Video</button>
        </form>

        <% if (message) { %>
            <p class="message <%= message.includes('Error') ? 'error' : message.includes('Warning') ? 'warning' : 'success' %>">
                <%= message %>
            </p>
        <% } %>

        <% if (downloadUrl) { %>
            <a href="<%= downloadUrl %>" download class="download-btn">Download Optimized Video</a>
            <button class="whatsapp-btn" onclick="shareToWhatsApp('<%= downloadUrl %>')">Share to WhatsApp</button>
        <% } %>

        <div id="progress" class="progress"></div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const progress = document.getElementById('progress');

        form.addEventListener('submit', () => {
            progress.textContent = 'Processing... (may take 1-2 minutes)';
        });

        function shareToWhatsApp(downloadUrl) {
            // Convert relative URL to absolute URL
            const absoluteUrl = window.location.origin + downloadUrl;

            // WhatsApp share URL
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent('Check out my optimized video form statusSnap! ' + absoluteUrl)}`;

            // Open Whatsapp in new tab
            window.open(whatsappUrl, "_blank");
        }

        // Alternative using web share API for native sharing (mobile devices)
        async function nativeShare(downloadUrl) {
            const absoluteUrl = window.location.origin + downloadUrl;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: "My WhatsApp Status Video",
                        text: "Check out my optimized video from statusSnap!",
                        url: absoluteUrl
                    });
                    console.log("Shared successfully");
                } catch (err) {
                    console.log("Error sharing:", err);
                    // Fallback to regular WhatsApp sharing
                    fallbackShare(absoluteUrl);
                }
            } else {
                // Fallback for browsers that don't support Web Share API
                fallbackShare(absoluteUrl);
            }
        }

        function fallbackShare(absoluteUrl) {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent('Check out my optimized video! ' + absoluteUrl)}`;
            window.open(whatsappUrl, "_blank");
        }

        // File detection
        function enhancedShare(downloadUrl) {
            const absoluteUrl = window.location.origin + downloadUrl;

            // Check if on mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                // For mobile, try native sharing first
                nativeShare(downloadUrl);
            } else {
                // For desktop, use regular WhatsApp web
                const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent('Check out my optimized video! ' + absoluteUrl)}`;
                window.open(whatsappUrl, "_blank");
            }
        }

        // Update the button to use enhanced version
        document.addEventListener("DOMContentLoaded", function() {
            const whatsappBtn = document.querySelector(".whatsapp-btn");
            if (whatsappBtn) {
                whatsappBtn.onclick = function() {
                    const downloadUrl = this.getAttribute("data-url") || "<%= downloadUrl %>";
                    enhancedShare(downloadUrl);
                };
            }
        });
    </script>
</body>
</html>