<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusSnap - WhatsApp Video Optimizer</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>StatusSnap</h1>
        <p>Optimize your videos for WhatsApp status (up to 90 seconds, no blur!)</p>

        <form id="uploadForm" enctype="multipart/form-data" method="POST" action="/process-video">
            <input type="file" name="video" accept="video/*" id="videoInput" required>

            <div class="button-container">
                <button type="submit" id="processBtn" class="process-btn">Process Video</button>

                <div class="progress-container hidden" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
        </form>

        <% if (message) { %>
            <p class="message <%= message.includes('Error') ? 'error' : message.includes('Warning') ? 'warning' : 'success' %>">
                <%= message %>
            </p>
        <% } %>

        <% if (downloadUrl) { %>
            <a href="<%= downloadUrl %>" download class="download-btn">Download Optimized Video</a>
            <button class="whatsapp-btn" onclick="shareToWhatsApp('<%= downloadUrl %>')">Share to WhatsApp</button>
        <% } %>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const progress = document.getElementById('progress');
        const processBtn =document.getElementById("processBtn");
        const progressContainer = document.getElementById("progressContainer");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const statusMessage = document.getElementById("statusMessage");
        const videoInput = document.getElementById("videoInput");

        let progressInterval;

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if(!videoInput.files[0]) {
                alert("Please select a video file first!");
                return;
            }
            // Show progress bar, hide button
            processBtn.classList.add("hidden");
            progressContainer.classList.remove("hidden");
            statusMessage.textContent = "Processing...";

            let progress = 0;
            progressInterval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress >= 95) {
                    progress = 95; //Hold at 95% until actual completion
                }
                updateProgress(progress);
            }, 500);

            // Actually submit the form
            this.submit();
        });

         function updateProgress(percent) {
            progressFill.style.width = percent + "%";
            progressText.textContent = Math.round(percent) + "%";

            // Update status message based on progress
            if (percent < 25) {
                statusMessage.textContent = "Analyzing video...";
            } else if (percent < 50) {
                statusMessage.textContent = "Processing video...";
            } else if (percent < 75) {
                statusMessage.textContent = "Optimizing for WhatsApp...";
            } else {
                statusMessage.textContent = "Finalizing...";
            }
         }

        //  Reset form when page loads (in case of refresh)
        window.addEventListener("load", function() {
            processBtn.classList.remove("hidden");
            progressContainer.classList.add("hidden");
            statusMessage.textContent = "";
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        });

        function shareToWhatsApp(downloadUrl) {
            // Convert relative URL to absolute URL
            const absoluteUrl = window.location.origin + downloadUrl;

            // WhatsApp share URL
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent('Check out my optimized video form statusSnap! ' + absoluteUrl)}`;

            // Open Whatsapp in new tab
            window.open(whatsappUrl, "_blank");
        }

        // Alternative using web share API for native sharing (mobile devices)
        async function nativeShare(downloadUrl) {
            const absoluteUrl = window.location.origin + downloadUrl;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: "My WhatsApp Status Video",
                        text: "Check out my optimized video from statusSnap!",
                        url: absoluteUrl
                    });
                    console.log("Shared successfully");
                } catch (err) {
                    console.log("Error sharing:", err);
                    // Fallback to regular WhatsApp sharing
                    fallbackShare(absoluteUrl);
                }
            } else {
                // Fallback for browsers that don't support Web Share API
                fallbackShare(absoluteUrl);
            }
        }

        function fallbackShare(absoluteUrl) {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent('Check out my optimized video! ' + absoluteUrl)}`;
            window.open(whatsappUrl, "_blank");
        }

        // File detection
        function enhancedShare(downloadUrl) {
            const absoluteUrl = window.location.origin + downloadUrl;

            // Check if on mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile && navigator.share) {
                navigator.share({
                    title: "My WhatsApp Status Video",
                    text: "Check out my optimized video!",
                    url: absoluteUrl
                }).catch(err => {
                    fallbackShare(absoluteUrl);
                });
            } else {
                fallbackShare(absoluteUrl);
            }
        }

        // Update the button to use enhanced version
        document.addEventListener("DOMContentLoaded", function() {
            const whatsappBtn = document.querySelector(".whatsapp-btn");
            if (whatsappBtn) {
                whatsappBtn.onclick = function() {
                    const downloadUrl = this.getAttribute("data-url") || "<%= downloadUrl %>";
                    enhancedShare(downloadUrl);
                };
            }
        });
    </script>
</body>
</html>