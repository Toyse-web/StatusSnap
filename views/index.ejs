<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusSnap - WhatsApp Video Optimizer</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>StatusSnap</h1>
        <p>Optimize your videos for WhatsApp status (up to 90 seconds, no blur!)</p>

        <form id="uploadForm" enctype="multipart/form-data" method="POST" action="/process-video">
            <input type="file" name="video" accept="video/*" id="videoInput" required>

            <div class="button-container">
                <button type="submit" id="processBtn" class="process-btn">Process Video</button>

                <div class="progress-container hidden" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
        </form>

        <% if (message) { %>
            <p class="message <%= message.includes('Error') ? 'error' : message.includes('Warning') ? 'warning' : 'success' %>">
                <%= message %>
            </p>
        <% } %>

        <% if (downloadUrl) { %>
            <div class="action-buttons">
                <button class="download-btn" onclick="downloadAndShare('<%= downloadUrl %>', '<%= typeof outputFilename !== 'undefined' ? outputFilename : downloadUrl.split('/').pop() %>')">Share video</button>
                <a href="<%= downloadUrl %>" download="<%= typeof outputFilename !== 'undefined' ? outputFilename : 'StatusSnap-video.mp4' %>" class="secondary-btn" id="downloadOnly">Download</a>
            </div>
        <% } %>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const progress = document.getElementById('progress');
        const processBtn =document.getElementById("processBtn");
        const progressContainer = document.getElementById("progressContainer");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const statusMessage = document.getElementById("statusMessage");
        const videoInput = document.getElementById("videoInput");

        let progressInterval;

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if(!videoInput.files[0]) {
                alert("Please select a video file first!");
                return;
            }
            // Show progress bar, hide button
            processBtn.classList.add("hidden");
            progressContainer.classList.remove("hidden");
            statusMessage.textContent = "Processing...";

            let progress = 0;
            progressInterval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress >= 95) {
                    progress = 95; //Hold at 95% until actual completion
                }
                updateProgress(progress);
            }, 500);

            // Actually submit the form
            this.submit();
        });

         function updateProgress(percent) {
            progressFill.style.width = percent + "%";
            progressText.textContent = Math.round(percent) + "%";

            // Update status message based on progress
            if (percent < 25) {
                statusMessage.textContent = "Analyzing video...";
            } else if (percent < 50) {
                statusMessage.textContent = "Processing video...";
            } else if (percent < 75) {
                statusMessage.textContent = "Optimizing for WhatsApp...";
            } else {
                statusMessage.textContent = "Finalizing...";
            }
         }

         async function downloadAndShare(downloadUrl, filename) {
            const downloadBtn = event.target;
            const originalText = downloadBtn.textContent;

            try {
                // Show loading state
                downloadBtn.textContent = "Downloading...";
                downloadBtn.disabled = true;

                // Download the file
                const response = await fetch(downloadUrl);
                const blob = await response.blob();
                const file = new File([blob], filename, {type: "video/mp4"});

                // Create object URL
                const fileUrl = URL.createObjectURL(blob);

                // Try native sharing first (mobile devices)
                if (navigator.share) {
                try {
                    await navigator.share({
                        files: [file],
                        title: "WhatsApp Status Video",
                        text: "Check out my optimized video from statusSnap!"
                    });
                    console.log("File shared successfully");
                    return;
                } catch (shareErr) {
                    console.log("Native share failed, trying WhatsApp direct...");
                }
            }

            // Fallback direct Whatsapp share
            await shareToWhatsApp(file, fileUrl, filename);
         } catch (error) {
            console.error("Download and share error:", error);
            alert("Error sharing video. Please download and share manually.");
         } finally {
            // Reset button
            downloadBtn.textContent = originalText;
            downloadBtn.disabled = false;
         }
        }

        async function shareToWhatsApp(file, fileUrl, filename) {
            // For mobile devices
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Mobile Whatsapp share
                const whatsappUrl = `whatsapp://send?text=Check out my status video!`;
                window.location.href = whatsappUrl;

                // If whatsapp doesn't open, suggest manual share
                setTimeout(() => {
                    if (!document.hidden) {
                        alert("Whatsapp not detected. Please share the downloaded video manually from your gallery.");
                    }
                }, 3000);
            } else {
                // For desktop, we can't share files directly to Whatsapp web.
                // Provide instructions
                alert("For desktop: Please download the video first, then upload it to WhatsApp Web manually.\n\nThe video has been downloaded to your device.");

                // Trigger download
                const a = document.createElement("a");
                a.href = fileUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            // Clean up object URL
            setTimeout(() => URL.revokeObjectURL(fileUrl), 1000);
        }

        // Alt method for mobile devices
        function shareViaDownload(downloadUrl, filename) {
            // First, download the file
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Then try to open whatsApp
            if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // Give a moment for download to complete
                setTimeout(() => {
                    const whatsappUrl = `whatsapp://`;
                    window.location.href = whatsappUrl;

                    // Instructions if whatsApp doesn't open
                    setTimeout(() => {
                         if (!document.hidden) {
                            alert('Video downloaded! Please open WhatsApp manually and upload the video from your gallery.');
                         }
                    }, 2000);
                }, 1000);
            } else {
                alert('Video downloaded! Please upload it to WhatsApp Web manually.');
            }
        }

        // Reset form page loads
        window.addEventListener("load", function() {
             processBtn.classList.remove('hidden');
            progressContainer.classList.add('hidden');
            statusMessage.textContent = '';
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        });
    </script>
</body>
</html>